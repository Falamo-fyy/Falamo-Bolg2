<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>用户管理</title>
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        h2 {
            color: #343a40;
            margin-bottom: 20px;
        }
        .table {
            margin-top: 20px;
            border-radius: 5px;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .alert {
            margin-top: 20px;
        }
        .action-buttons {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .checkbox-column {
            width: 40px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h2>用户管理</h2>
        
        <!-- 成功或错误消息 -->
        <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
        <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>
        
        <!-- 批量操作按钮 -->
        <div class="action-buttons">
            <div>
                <button id="selectAllBtn" class="btn btn-outline-secondary btn-sm">全选</button>
                <button id="deselectAllBtn" class="btn btn-outline-secondary btn-sm">取消全选</button>
            </div>
            <div>
                <form id="batchDeleteForm" th:action="@{/admin/users/batch-delete}" method="post" style="display: inline-block; margin-right: 10px;">
                    <input type="hidden" id="selectedUserIds" name="userIds" value="">
                    <button type="submit" id="batchDeleteBtn" class="btn btn-danger" disabled
                            onclick="return confirmBatchDelete()">
                        批量删除 (<span id="selectedCount">0</span>)
                    </button>
                </form>
                <form th:action="@{/admin/users/delete-test-users}" method="post" style="display: inline-block;">
                    <button type="submit" class="btn btn-warning"
                            onclick="return confirm('确定要删除所有以testuser开头的测试用户吗？此操作不可撤销！')">
                        删除测试用户
                    </button>
                </form>
            </div>
        </div>
        
        <table class="table table-striped">
            <thead>
                <tr>
                    <th class="checkbox-column"><input type="checkbox" id="selectAll"></th>
                    <th>ID</th>
                    <th>用户名</th>
                    <th>邮箱</th>
                    <th>状态</th>
                    <th>创建时间</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="user : ${users}">
                    <td class="checkbox-column">
                        <input type="checkbox" class="user-checkbox" th:value="${user.id}" 
                               th:data-username="${user.username}">
                    </td>
                    <td th:text="${user.id}"></td>
                    <td th:text="${user.username}"></td>
                    <td th:text="${user.email}"></td>
                    <td>
                        <span th:if="${user.status == 1}" class="badge bg-success">正常</span>
                        <span th:if="${user.status == 0}" class="badge bg-danger">禁用</span>
                    </td>
                    <td th:text="${#dates.format(user.createdAt, 'yyyy-MM-dd HH:mm')}"></td>
                    <td>
                        <form th:action="@{/admin/users/{id}/delete(id=${user.id})}" method="post" style="display: inline;">
                            <button type="submit" class="btn btn-danger btn-sm"
                                    onclick="return confirm('确定要删除用户 ' + [[${user.username}]] + ' 吗？')">
                                删除
                            </button>
                        </form>
                    </td>
                </tr>
            </tbody>
        </table>
        
        <a th:href="@{/}" class="btn btn-primary">返回首页</a>
    </div>
    
    <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <script>
        // 全选/取消全选功能
        document.getElementById('selectAll').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.user-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateSelectedCount();
        });
        
        // 全选按钮
        document.getElementById('selectAllBtn').addEventListener('click', function() {
            document.getElementById('selectAll').checked = true;
            const checkboxes = document.querySelectorAll('.user-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
            updateSelectedCount();
        });
        
        // 取消全选按钮
        document.getElementById('deselectAllBtn').addEventListener('click', function() {
            document.getElementById('selectAll').checked = false;
            const checkboxes = document.querySelectorAll('.user-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            updateSelectedCount();
        });
        
        // 监听单个复选框变化
        document.querySelectorAll('.user-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateSelectedCount();
                
                // 检查是否所有复选框都被选中
                const allChecked = Array.from(document.querySelectorAll('.user-checkbox'))
                    .every(cb => cb.checked);
                document.getElementById('selectAll').checked = allChecked;
            });
        });
        
        // 更新选中计数和批量删除按钮状态
        function updateSelectedCount() {
            const selectedCheckboxes = document.querySelectorAll('.user-checkbox:checked');
            const count = selectedCheckboxes.length;
            document.getElementById('selectedCount').textContent = count;
            
            // 更新隐藏字段的值
            const selectedIds = Array.from(selectedCheckboxes)
                .map(checkbox => checkbox.value)
                .join(',');
            document.getElementById('selectedUserIds').value = selectedIds;
            
            // 启用或禁用批量删除按钮
            document.getElementById('batchDeleteBtn').disabled = count === 0;
        }
        
        // 批量删除确认
        function confirmBatchDelete() {
            const selectedCheckboxes = document.querySelectorAll('.user-checkbox:checked');
            const count = selectedCheckboxes.length;
            
            if (count === 0) {
                alert('请至少选择一个用户');
                return false;
            }
            
            // 获取所有选中用户的用户名
            const usernames = Array.from(selectedCheckboxes)
                .map(checkbox => checkbox.getAttribute('data-username'))
                .join('\n- ');
            
            return confirm(`确定要删除以下 ${count} 个用户吗？\n- ${usernames}`);
        }
    </script>
</body>
</html>